<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Open Efficiency Index Database - Search 400+ appliances by regional efficiency ratings">
    
    <title>Database - Open Efficiency Index</title>
    
    <!-- Preload critical fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">
    
    <!-- Chart.js for visualizations -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- Import editorial design system from landing -->
    <link rel="stylesheet" href="../landing/styles.css">
    
    <style>
        /* ===================================
           DATABASE-SPECIFIC STYLES
           =================================== */
        
        .main-content {
            padding-top: calc(80px + var(--space-6));
            min-height: 100vh;
            background: var(--color-white);
        }
        
        .database-header {
            text-align: center;
            margin-bottom: var(--space-6);
            padding: var(--space-4) var(--space-6);
        }
        
        .database-title {
            font-size: var(--text-3xl);
            font-weight: 800;
            letter-spacing: -0.02em;
            color: var(--color-black);
            margin-bottom: var(--space-1);
        }
        
        .database-subtitle {
            font-size: var(--text-base);
            color: var(--color-gray-600);
            max-width: 600px;
            margin: 0 auto;
        }
        
        /* Search Section - Horizontal Layout */
        .search-section {
            max-width: 1200px;
            margin: 0 auto var(--space-8);
            padding: 0 var(--space-6);
        }
        
        .search-card {
            background: var(--color-gray-50);
            border: 1px solid var(--color-gray-200);
            border-radius: var(--radius);
            padding: var(--space-4);
            box-shadow: none;
        }
        
        .search-title {
            font-size: var(--text-lg);
            font-weight: 600;
            color: var(--color-black);
            margin-bottom: var(--space-3);
        }
        
        .search-grid {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr auto;
            gap: var(--space-4);
            align-items: end;
            margin-bottom: 0;
        }
        
        .form-group {
            display: flex;
            flex-direction: column;
        }
        
        .form-group label {
            font-weight: 500;
            color: var(--color-gray-700);
            margin-bottom: var(--space-1);
            font-size: var(--text-xs);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        
        .form-control {
            padding: var(--space-2) var(--space-3);
            border: 1px solid var(--color-gray-300);
            border-radius: var(--radius);
            font-size: var(--text-sm);
            font-family: var(--font-display);
            transition: var(--transition);
            height: 40px;
        }
        
        .form-control:focus {
            outline: none;
            border-color: var(--color-accent);
            box-shadow: 0 0 0 3px rgba(0, 102, 204, 0.1);
        }
        
        .search-button {
            background: var(--color-black);
            color: var(--color-white);
            border: none;
            padding: var(--space-2) var(--space-6);
            border-radius: var(--radius);
            font-weight: 600;
            font-size: var(--text-sm);
            cursor: pointer;
            transition: var(--transition);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            height: 40px;
            white-space: nowrap;
        }
        
        .search-button:hover {
            background: var(--color-gray-800);
            transform: translateY(-1px);
        }
        
        /* Results Section */
        .results-section {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 var(--space-6) var(--space-8);
        }
        
        .results-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--space-4);
            padding-bottom: var(--space-2);
            border-bottom: 1px solid var(--color-gray-200);
        }
        
        .results-count {
            font-family: var(--font-mono);
            font-size: var(--text-lg);
            font-weight: 600;
            color: var(--color-accent);
        }
        
        .view-toggle {
            display: flex;
            background: var(--color-gray-100);
            border-radius: var(--radius);
            padding: var(--space-1);
        }
        
        .view-btn {
            padding: var(--space-2) var(--space-4);
            border: none;
            background: transparent;
            font-weight: 500;
            border-radius: var(--radius-sm);
            cursor: pointer;
            transition: var(--transition);
        }
        
        .view-btn.active {
            background: var(--color-white);
            box-shadow: var(--shadow-sm);
        }
        
        /* Table View */
        .results-table {
            width: 100%;
            border-collapse: collapse;
            background: var(--color-white);
            border-radius: var(--radius-lg);
            overflow: hidden;
            box-shadow: var(--shadow);
        }
        
        .results-table th {
            background: var(--color-gray-50);
            padding: var(--space-2) var(--space-3);
            text-align: left;
            font-weight: 600;
            color: var(--color-gray-700);
            font-size: var(--text-xs);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        
        /* Energy Star column styling */
        .results-table th:nth-child(4),
        .results-table td:nth-child(4) {
            text-align: center;
            width: 80px;
        }
        
        .results-table td {
            padding: var(--space-2) var(--space-3);
            border-top: 1px solid var(--color-gray-100);
            font-size: var(--text-sm);
            vertical-align: top;
        }
        
        .results-table tr:hover {
            background: var(--color-gray-50);
        }
        
        .efficiency-score {
            font-family: var(--font-mono);
            font-weight: 600;
            color: var(--color-accent);
        }
        
        /* Chart Container */
        .chart-container {
            background: var(--color-white);
            border: 1px solid var(--color-gray-200);
            border-radius: var(--radius-lg);
            padding: var(--space-4);
            margin-bottom: var(--space-4);
            box-shadow: var(--shadow);
        }
        
        /* Loading and Error States */
        .loading {
            text-align: center;
            padding: var(--space-8);
            color: var(--color-gray-500);
        }
        
        .error {
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid rgba(239, 68, 68, 0.2);
            color: #dc2626;
            padding: var(--space-3);
            border-radius: var(--radius);
            margin-bottom: var(--space-4);
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .search-grid {
                grid-template-columns: 1fr;
            }
            
            .results-header {
                flex-direction: column;
                gap: var(--space-2);
                align-items: stretch;
            }
            
            .results-table {
                font-size: var(--text-xs);
            }
            
            .results-table th,
            .results-table td {
                padding: var(--space-1) var(--space-2);
            }
        }
    </style>
</head>
<body>
    <!-- Header - Consistent with Landing Page -->
    <header class="header">
        <nav class="nav">
            <div class="nav-brand">
                <span class="brand-mark">●</span>
                <span class="brand-text">Open Efficiency Index</span>
            </div>
            
            <div class="nav-actions">
                <a href="../index.html" class="nav-link">← Back</a>
                <a href="regional-efficiency-map.html" class="nav-link">Regional Map</a>
                <a href="../index.html#api" class="btn-primary">
                    API Docs →
                </a>
            </div>
        </nav>
    </header>

    <!-- Main Content -->
    <main class="main-content">
        <!-- Database Header -->
        <section class="database-header">
            <h1 class="database-title">Appliance Database</h1>
            <p class="database-subtitle">
                Search and compare 400+ appliances with regional efficiency ratings beyond ENERGY STAR
            </p>
        </section>

        <!-- Search Section -->
        <section class="search-section">
            <div class="search-card">
                <h2 class="search-title">Find Appliances</h2>
                
                <div class="search-grid">
                    <div class="form-group">
                        <label for="category">Appliance Category</label>
                        <select id="category" class="form-control">
                            <option value="">All Categories</option>
                            <option value="refrigerators">Refrigerators</option>
                            <option value="dishwashers">Dishwashers</option>
                            <option value="clothes_washers">Clothes Washers</option>
                            <option value="water_heaters">Water Heaters</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="brand">Brand</label>
                        <input type="text" id="brand" class="form-control" placeholder="e.g. Samsung, LG, Whirlpool">
                    </div>
                    
                    <div class="form-group">
                        <label for="efficiency">Min Efficiency Score</label>
                        <input type="number" id="efficiency" class="form-control" placeholder="0-100" min="0" max="100">
                    </div>
                    
                    <div class="form-group">
                        <label>&nbsp;</label>
                        <button class="search-button" onclick="searchAppliances()">
                            Search Database
                        </button>
                    </div>
                </div>
            </div>
        </section>

        <!-- Results Section -->
        <section class="results-section">
            <div class="results-header">
                <div class="results-count" id="resultsCount">
                    Select a category above to search appliances
                </div>
                
                <div class="view-toggle">
                    <button class="view-btn active" onclick="switchView('table')">Table</button>
                    <button class="view-btn" onclick="switchView('chart')">Chart</button>
                </div>
            </div>

            <!-- Loading State -->
            <div id="loading" class="loading" style="display: none;">
                <div>Searching database...</div>
            </div>

            <!-- Error State -->
            <div id="error" class="error" style="display: none;">
                <strong>Error:</strong> <span id="errorMessage"></span>
            </div>

            <!-- Table View -->
            <div id="tableView" class="table-view">
                <table class="results-table">
                    <thead>
                        <tr>
                            <th>Brand & Model</th>
                            <th>Category</th>
                            <th>Efficiency Score</th>
                            <th>ENERGY STAR</th>
                            <th>Annual Cost</th>
                            <th>CO₂ Impact</th>
                            <th>Energy Use</th>
                        </tr>
                    </thead>
                    <tbody id="resultsTableBody">
                        <!-- Results will be populated by JavaScript -->
                    </tbody>
                </table>
            </div>

            <!-- Chart View -->
            <div id="chartView" class="chart-view" style="display: none;">
                <div class="chart-container">
                    <canvas id="efficiencyChart" width="400" height="200"></canvas>
                </div>
            </div>
        </section>
    </main>

    <!-- JavaScript for Database Functionality -->
    <script>
        const API_BASE_URL = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1'
            ? 'http://localhost:8080' 
            : '/api';

        let currentData = [];
        let chart = null;

        async function searchAppliances() {
            const category = document.getElementById('category').value;
            const brand = document.getElementById('brand').value;
            const efficiency = document.getElementById('efficiency').value;

            // Require category selection
            if (!category) {
                showError('Please select an appliance category first');
                return;
            }

            // Show loading
            showLoading(true);
            hideError();

            try {
                let url = `${API_BASE_URL}/search?`;
                const params = [];
                
                params.push(`category=${category}`);
                if (brand) params.push(`brand=${encodeURIComponent(brand)}`);
                if (efficiency) params.push(`min_efficiency=${efficiency}`);
                params.push('limit=50');
                
                url += params.join('&');

                const response = await fetch(url);
                
                if (!response.ok) {
                    throw new Error(`API Error: ${response.status}`);
                }

                const data = await response.json();
                currentData = data.appliances || [];
                
                updateResultsCount(currentData.length);
                displayResults(data);
                
            } catch (error) {
                console.error('Search error:', error);
                showError(`Failed to search appliances: ${error.message}`);
                updateResultsCount(0);
                clearResults();
            } finally {
                showLoading(false);
            }
        }

        function displayResults(data = null) {
            const activeView = document.querySelector('.view-btn.active').textContent.toLowerCase();
            
            if (activeView === 'table') {
                displayTableResults(data);
            } else {
                displayChartResults(data);
            }
        }

        function displayTableResults(data = null) {
            const tbody = document.getElementById('resultsTableBody');
            
            if (currentData.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" style="text-align: center; padding: var(--space-16); color: var(--color-gray-500);">
                            No appliances found matching your criteria
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = currentData.map(appliance => `
                <tr>
                    <td>
                        <strong>${appliance.manufacturer || 'Unknown'}</strong><br>
                        <small style="color: var(--color-gray-500);">${appliance.model_number || appliance.model || 'No model'}</small>
                    </td>
                    <td>${formatCategory(data.category || appliance.category)}</td>
                    <td><span class="efficiency-score">${Math.round(appliance.open_efficiency_score || 0)}</span></td>
                    <td>
                        ${appliance.energy_star_certified ? 
                            '<img src="./ENE_logo_Cert_v_copyright_v2.jpg.webp" alt="ENERGY STAR Certified" style="height: 24px; width: auto;" title="ENERGY STAR Certified">' : 
                            '<span style="color: var(--color-gray-400); font-size: var(--text-xs);">—</span>'
                        }
                    </td>
                    <td>$${Math.round(appliance.annual_cost_us_average || 0)}/yr</td>
                    <td>${Math.round(appliance.annual_co2_lbs_us_average || 0)} lbs/yr</td>
                    <td>${Math.round(appliance.annual_energy_kwh || 0)} kWh/yr</td>
                </tr>
            `).join('');
        }

        function displayChartResults(data = null) {
            if (currentData.length === 0) return;

            const ctx = document.getElementById('efficiencyChart').getContext('2d');
            
            // Destroy existing chart
            if (chart) {
                chart.destroy();
            }

            // Create efficiency score distribution (histogram)
            const bins = {
                '0-20': 0,
                '21-40': 0,
                '41-60': 0,
                '61-80': 0,
                '81-100': 0
            };

            currentData.forEach(appliance => {
                const score = appliance.open_efficiency_score || 0;
                if (score <= 20) bins['0-20']++;
                else if (score <= 40) bins['21-40']++;
                else if (score <= 60) bins['41-60']++;
                else if (score <= 80) bins['61-80']++;
                else bins['81-100']++;
            });

            const labels = Object.keys(bins);
            const counts = Object.values(bins);

            // Get category name for title
            const category = data?.category || document.getElementById('category').value || 'appliances';
            const categoryName = formatCategory(category);

            chart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Number of Appliances',
                        data: counts,
                        backgroundColor: 'rgba(0, 102, 204, 0.8)',
                        borderColor: 'rgba(0, 102, 204, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        title: {
                            display: true,
                            text: `Efficiency Score Distribution - ${categoryName}`,
                            font: {
                                size: 16,
                                weight: 'bold'
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Number of Appliances'
                            },
                            ticks: {
                                stepSize: 1
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Efficiency Score Range'
                            }
                        }
                    }
                }
            });
        }

        function switchView(view) {
            // Update button states
            document.querySelectorAll('.view-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');

            // Show/hide views
            const tableView = document.getElementById('tableView');
            const chartView = document.getElementById('chartView');

            if (view === 'table') {
                tableView.style.display = 'block';
                chartView.style.display = 'none';
            } else {
                tableView.style.display = 'none';
                chartView.style.display = 'block';
                displayChartResults();
            }
        }

        function formatCategory(category) {
            const categoryMap = {
                'refrigerators': 'Refrigerators',
                'dishwashers': 'Dishwashers',
                'clothes_washers': 'Clothes Washers',
                'water_heaters': 'Water Heaters'
            };
            return categoryMap[category] || category;
        }

        function updateResultsCount(count) {
            const element = document.getElementById('resultsCount');
            if (count === 0) {
                element.textContent = 'No results found';
            } else {
                element.textContent = `Found ${count} appliances`;
            }
        }

        function showLoading(show) {
            document.getElementById('loading').style.display = show ? 'block' : 'none';
        }

        function showError(message) {
            document.getElementById('errorMessage').textContent = message;
            document.getElementById('error').style.display = 'block';
        }

        function hideError() {
            document.getElementById('error').style.display = 'none';
        }

        function clearResults() {
            currentData = [];
            const tbody = document.getElementById('resultsTableBody');
            tbody.innerHTML = `
                <tr>
                    <td colspan="6" style="text-align: center; padding: var(--space-16); color: var(--color-gray-500);">
                        Select a category above to search appliances
                    </td>
                </tr>
            `;
        }

        // Load some initial data on page load
        window.addEventListener('load', () => {
            // Clear any existing results and show initial state
            clearResults();
            updateResultsCount(0);
            document.getElementById('resultsCount').textContent = 'Select a category above to search appliances';
        });
    </script>
</body>
</html>